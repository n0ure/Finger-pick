<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Random Finger Chooser</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Finger Pick">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    html, body { margin:0; height:100%; background:#111; color:#eee; font-family: system-ui, -apple-system, Roboto, Segoe UI, Arial, sans-serif; }
    #c { display:block; width:100vw; height:100vh; touch-action:none; cursor:default; }
    .hint { position:fixed; left:50%; top:64px; transform:translateX(-50%); opacity:.85; font-size:14px; background:#222; padding:8px 12px; border-radius:12px; -webkit-user-select:none; user-select:none; }
    .timer { position:fixed; left:50%; top:14px; transform:translateX(-50%); font-variant-numeric: tabular-nums; opacity:.95; font-weight:700; font-size:clamp(22px, 6vw, 40px); text-shadow:0 2px 6px rgba(0,0,0,.5); -webkit-user-select:none; user-select:none; }
    .btn { position:fixed; left:50%; bottom:16px; transform:translateX(-50%); background:#333; border:1px solid #444; color:#eee; padding:12px 18px; border-radius:14px; font-weight:600; }
    .a2hs { position:fixed; left:50%; bottom:72px; transform:translateX(-50%); background:#222; border:1px solid #333; border-radius:12px; padding:8px 12px; font-size:13px; opacity:.9; }
    @media (display-mode: standalone) {
      .a2hs { display:none; }
    }
  </style>
</head>
<body>
  <canvas id="c"></canvas>
  <div class="timer" id="timer"></div>
  <div class="hint">Posez plusieurs doigts • Sélection auto après 3 s</div>
  <button class="btn" id="resetBtn">Recommencer</button>
  <div class="a2hs" id="a2hs">Astuce : Safari → <b>Partager</b> → <b>Ajouter à l’écran d’accueil</b></div>
  <script>
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d', { alpha: false });
    const timerEl = document.getElementById('timer');
    const resetBtn = document.getElementById('resetBtn');
    let a2hsEl = document.getElementById('a2hs');

    // PWA: Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }

    // DPR helpers
    function dpr(){ return window.devicePixelRatio || 1; }

    // Resize canvas
    function fit() { 
      const ratio = dpr();
      canvas.width = Math.floor(window.innerWidth * ratio); 
      canvas.height = Math.floor(window.innerHeight * ratio); 
    }
    window.addEventListener('resize', fit, {passive:true}); fit();

    const COLORS = ['#ff5a5f','#2ecc71','#3498db','#f1c40f','#9b59b6','#e67e22','#1abc9c','#e84393','#16a085','#e74c3c'];

    // State
    const touches = new Map(); // id -> {x,y,color}
    let selectionTimer = null;
    let countdownStart = 0;
    const COUNTDOWN_MS = 3000;
    let winnerId = null;
    let selectionMade = false;
    let winScreenColor = null;

    // Utils
    function now(){ return performance.now(); }
    function scheduleSelection(){
      cancelSelection();
      if (touches.size >= 2){
        countdownStart = now();
        selectionTimer = setTimeout(pickRandomWinner, COUNTDOWN_MS);
      } else { timerEl.textContent = ''; }
    }
    function cancelSelection(){
      if (selectionTimer){ clearTimeout(selectionTimer); selectionTimer = null; }
      countdownStart = 0; timerEl.textContent = '';
    }
    function pickRandomWinner(){
      if (touches.size === 0) return;
      const keys = Array.from(touches.keys());
      winnerId = keys[Math.floor(Math.random()*keys.length)];
      selectionMade = true;
      const win = touches.get(winnerId);
      winScreenColor = win ? win.color : '#111111';
      try { if (navigator.vibrate) navigator.vibrate([12,40,12]); } catch(e){}
      for (const id of keys){
        if (id !== winnerId){ touches.delete(id); }
      }
      timerEl.textContent = 'Gagnant ✅';
    }
    function fullReset(){
      touches.clear();
      winnerId = null;
      selectionMade = false;
      winScreenColor = null;
      cancelSelection();
    }
    resetBtn.addEventListener('click', fullReset);

    // Touch events
    function handleStart(ev){
      ev.preventDefault();
      for (const t of ev.changedTouches){
        const id = t.identifier;
        if (!touches.has(id)){
          const color = COLORS[(touches.size) % COLORS.length];
          const ratio = dpr();
          touches.set(id, { x: t.clientX*ratio, y: t.clientY*ratio, color });
        }
      }
      if (!selectionMade) scheduleSelection();
    }
    function handleMove(ev){
      ev.preventDefault();
      for (const t of ev.changedTouches){
        const id = t.identifier;
        const item = touches.get(id);
        const ratio = dpr();
        if (item){ item.x = t.clientX*ratio; item.y = t.clientY*ratio; }
      }
    }
    function handleEnd(ev){
      ev.preventDefault();
      for (const t of ev.changedTouches){
        touches.delete(t.identifier);
        if (t.identifier === winnerId) { 
          winnerId = null; selectionMade = false; winScreenColor = null;
        }
      }
      if (!selectionMade){
        if (touches.size < 2) cancelSelection();
        else scheduleSelection();
      }
    }
    canvas.addEventListener('touchstart', handleStart, {passive:false});
    canvas.addEventListener('touchmove', handleMove, {passive:false});
    canvas.addEventListener('touchend', handleEnd, {passive:false});
    canvas.addEventListener('touchcancel', handleEnd, {passive:false});

    // Drawing
    function draw(){
      // Background: normal or winner color
      ctx.fillStyle = winScreenColor || '#111';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // Countdown text (top)
      if (selectionTimer && countdownStart){
        const remaining = Math.max(0, COUNTDOWN_MS - (now()-countdownStart));
        timerEl.textContent = `Sélection dans ${(remaining/1000).toFixed(1)} s`;
      }

      // Sizing: larger rings to be visible even under a finger
      const ratio = dpr();
      const cssMin = Math.min(window.innerWidth, window.innerHeight);
      const radiusCSS = Math.max(cssMin * 0.12, 52); // 12% of short side, at least 52 CSS px
      const R = radiusCSS * ratio;                   // device pixels
      const baseRingW = R * 0.2;

      for (const [id, f] of touches.entries()){
        // filled disc (semi-transparent)
        ctx.beginPath();
        ctx.arc(f.x, f.y, R * 0.75, 0, Math.PI*2);
        ctx.fillStyle = (winScreenColor && id === winnerId) ? '#00000022' : (f.color + '33');
        ctx.fill();

        // ring
        const isWinner = (id === winnerId);
        ctx.lineWidth = Math.max(10*ratio, isWinner ? baseRingW*1.3 : baseRingW);
        // Contrast if background already uses the winner color
        ctx.strokeStyle = (winScreenColor && isWinner) ? '#ffffff' : f.color;
        ctx.beginPath();
        ctx.arc(f.x, f.y, R, 0, Math.PI*2);
        ctx.stroke();
      }

      requestAnimationFrame(draw);
    }
    draw();

    // iOS: prevent unwanted gestures
    document.addEventListener('gesturestart', e => e.preventDefault());
  </script>
</body>
</html>
